@page "/auth-test"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation

<PageTitle>Test de Autenticación</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium">
    <MudText Typo="Typo.h3" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.Security" Class="mr-2" />
        Test de Autenticación
    </MudText>

    <MudCard Class="mb-4">
        <MudCardContent>
            <MudText Typo="Typo.h6" Class="mb-3">Estado Actual</MudText>
            
            @if (authState != null)
            {
                @if (authState.User.Identity?.IsAuthenticated == true)
                {
                    <MudAlert Severity="Severity.Success" Class="mb-3">
                        <strong>✅ Usuario autenticado</strong>
                        <br />Nombre: @authState.User.Identity.Name
                        <br />Total Claims: @authState.User.Claims.Count()
                    </MudAlert>
                }
                else
                {
                    <MudAlert Severity="Severity.Info" Class="mb-3">
                        <strong>ℹ️ Usuario no autenticado</strong>
                        <br />Para probar el sistema, haz clic en "Test Login"
                    </MudAlert>
                }
            }

            <MudStack Row="true" Spacing="2" Class="mt-3">
                @if (authState?.User.Identity?.IsAuthenticated != true)
                {
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Success" 
                               OnClick="TestLogin"
                               StartIcon="@Icons.Material.Filled.Login">
                        Test Login
                    </MudButton>
                }
                else
                {
                    <MudButton Variant="Variant.Outlined" 
                               Color="Color.Warning" 
                               OnClick="TestLogout"
                               StartIcon="@Icons.Material.Filled.Logout">
                        Test Logout
                    </MudButton>
                }
            </MudStack>
        </MudCardContent>
    </MudCard>

    <MudCard Class="mb-4">
        <MudCardContent>
            <MudText Typo="Typo.h6" Class="mb-3">URLs de Prueba</MudText>
            <MudText Typo="Typo.body2" Class="mb-2">
                Después del deployment, estas URLs deberían funcionar correctamente:
            </MudText>
            
            <MudList T="string" Clickable="false" Dense="true">
                <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle">
                    <div>
                        <MudLink Href="/authentication/login-callback" Target="_blank">/authentication/login-callback</MudLink>
                        <br />
                        <small class="text-muted">Callback de login - debe mostrar la app</small>
                    </div>
                </MudListItem>
                <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle">
                    <div>
                        <MudLink Href="/authentication/logout-callback" Target="_blank">/authentication/logout-callback</MudLink>
                        <br />
                        <small class="text-muted">Callback de logout - debe mostrar la app</small>
                    </div>
                </MudListItem>
                <MudListItem T="string" Icon="@Icons.Material.Filled.Settings">
                    <div>
                        <MudLink Href="/staticwebapp.config.json" Target="_blank">/staticwebapp.config.json</MudLink>
                        <br />
                        <small class="text-muted">Archivo de configuración - debe mostrar JSON</small>
                    </div>
                </MudListItem>
            </MudList>
        </MudCardContent>
    </MudCard>

    <MudStack Row="true" Spacing="2">
        <MudButton Variant="Variant.Outlined" 
                   Color="Color.Primary" 
                   Href="/debug-auth"
                   StartIcon="@Icons.Material.Filled.BugReport">
            Debug Avanzado
        </MudButton>
        
        <MudButton Variant="Variant.Outlined" 
                   Color="Color.Primary" 
                   Href="/"
                   StartIcon="@Icons.Material.Filled.Home">
            Volver al Inicio
        </MudButton>
    </MudStack>
</MudContainer>

@code {
    private AuthenticationState? authState;

    protected override async Task OnInitializedAsync()
    {
        authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
    }

    private void TestLogin()
    {
        Navigation.NavigateToLogin("/authentication/login");
    }

    private void TestLogout()
    {
        Navigation.NavigateToLogout("/authentication/logout");
    }
}