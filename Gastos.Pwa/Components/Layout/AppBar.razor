@implements IDisposable
@inject NavigationManager Navigation
@inject StateContainer StateContainer
@inject LocalizationService Loc

<MudAppBar Elevation="3" Dense>

    <NoNetworkMonitor />

    @if (StateContainer.IsMobile)
    {
        <Menu MenuType="superior" />
    }

    <MudIconButton Icon="@Icons.Material.Filled.Home" Color="Color.Inherit" Edge="Edge.Start" Href="/" Class="ms-1" />

    <MudText Typo="@(StateContainer.IsMobile ? Typo.body1 : Typo.h6)" Class="ms-5">
        @StateContainer.PageTitle
    </MudText>
    <MudSpacer />

    <AuthorizeView>
        <Authorized>
            <MudHidden Breakpoint="Breakpoint.SmAndDown">
                <MudText Typo="Typo.subtitle1" Class="mr-2">
                    @context.User.GetUserName()
                </MudText>
            </MudHidden>
            <MudTooltip Text="@Loc.Get(RS.ActLogout)">
                <MudIconButton Icon="@Icons.Material.Filled.Logout" Color="Color.Inherit" OnClick="BeginLogout" />
            </MudTooltip>
        </Authorized>
        <NotAuthorized>
            <MudChip T="string" Color="Color.Warning" Variant="Variant.Outlined" Size="@(StateContainer.IsMobile ? Size.Small: Size.Medium)">
                @Loc.Get(StateContainer.IsMobile ? RS.DemoModeMsg1 : RS.DemoModeMsg2)
            </MudChip>
            <MudSpacer />       
            <MudTooltip Text="@Loc.Get(RS.ActLogin)">
                <MudIconButton Icon="@Icons.Material.Filled.Login" Color="Color.Inherit" Href="authentication/login" />
            </MudTooltip>
        </NotAuthorized>
    </AuthorizeView>

    <ConfigSelector />

</MudAppBar>

@code {
    protected override void OnInitialized()
    {
        StateContainer.PageTitleChanged += OnPageTitleChanged;
        StateContainer.BreakpointChanged += OnBreakpointChanged;
    }

    private void BeginLogout()
    {
        Navigation.NavigateToLogout("/authentication/logout");
    }

    private void OnPageTitleChanged() => StateHasChanged();
    private void OnBreakpointChanged() => StateHasChanged();

    public void Dispose()
    {
        StateContainer.PageTitleChanged -= OnPageTitleChanged;
        StateContainer.BreakpointChanged -= OnBreakpointChanged;
    }
}