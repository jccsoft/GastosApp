<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registro de Tíquets</title>
    <base href="/" />
    <link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/app.css" />
    <link rel="stylesheet" href="css/site.css" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <link href="Gastos.Pwa.styles.css" rel="stylesheet" />
    <link href="manifest.webmanifest" rel="manifest" />
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png" />
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
    <!-- Important: Increment the version parameter whenever you update MudBlazor to prevent caching issues -->
    <link href="_content/MudBlazor/MudBlazor.min.css?v=1" rel="stylesheet" />
    
    <!-- Cache prevention for main HTML -->
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="0">
</head>

<body>
    <div id="app">
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>
    </div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="." class="reload">Reload</a>
        <span class="dismiss">🗙</span>
    </div>

    <!-- PWA Diagnostics - Load First -->
    <!--<script src="js/pwa-diagnostics.js"></script>-->

    <!-- PWA Routing Check -->
    <!--<script src="js/pwa-routing-check.js"></script>-->

    <!-- PWA Scripts -->
    <script src="js/pwa-installer.js"></script>
    <script src="js/pwa-helper.js"></script>
    <script src="js/pwa-updater.js"></script>
    <!--<script src="js/pwa-update-tester.js"></script>-->

    <!-- Authentication Script -->
    <script src="_content/Microsoft.AspNetCore.Components.WebAssembly.Authentication/AuthenticationService.js"></script>

    <!-- Auth Debug Script -->
    <script src="js/auth-debug.js"></script>

    <!-- Azure Routing Test -->
    <!--<script src="js/azure-routing-test.js"></script>-->

    <!-- Utility Scripts -->
    <script src="js/clipboard-helper.js"></script>
    <script src="js/culture-helper.js"></script>

    <!-- Blazor WebAssembly -->
    <script src="_framework/blazor.webassembly.js"></script>

    <!-- MudBlazor JS -->
    <script src="_content/MudBlazor/MudBlazor.min.js?v=1"></script>

    <!-- Application Initialization Script -->
    <script>
        // Detectar modo de desarrollo vs producción
        const isDevelopment = window.location.hostname === 'localhost' ||
            window.location.hostname === '127.0.0.1' ||
            window.location.hostname.includes('localhost');

        console.log(`🔧 Environment: ${isDevelopment ? 'Development' : 'Production'}`);

        // Manejo global de errores relacionados con autenticación
        window.addEventListener('error', function (event) {
            if (event.filename && event.filename.includes('authentication')) {
                console.error('🔐 Authentication error:', {
                    message: event.message,
                    filename: event.filename,
                    line: event.lineno,
                    column: event.colno
                });
            }
        });

        // Manejo de promesas rechazadas relacionadas con autenticación
        window.addEventListener('unhandledrejection', function (event) {
            if (event.reason && event.reason.toString().toLowerCase().includes('auth')) {
                console.error('🔐 Authentication promise rejection:', event.reason);
            }
        });

        // Log del estado inicial de la aplicación
        console.log('🚀 Application loading...', {
            url: window.location.href,
            hostname: window.location.hostname,
            isPWA: window.matchMedia('(display-mode: standalone)').matches,
            hasServiceWorker: 'serviceWorker' in navigator,
            isDevelopment: isDevelopment,
            userAgent: navigator.userAgent,
            timestamp: new Date().toISOString()
        });

        // Verificar que todos los scripts se hayan cargado
        window.addEventListener('load', () => {
            setTimeout(() => {
                const loadedTools = [];
                if (typeof window.AuthDebugger !== 'undefined') loadedTools.push('AuthDebugger');
                if (typeof window.PWAInstaller !== 'undefined') loadedTools.push('PWAInstaller');
                if (typeof window.PWARoutingDebug !== 'undefined') loadedTools.push('PWARoutingDebug');
                if (typeof window.testAzureRouting !== 'undefined') loadedTools.push('AzureRoutingTest');
                if (typeof window.pwaUpdater !== 'undefined') loadedTools.push('PWAUpdater');
                if (typeof window.diagnoseApp !== 'undefined') loadedTools.push('PWADiagnostics');
                if (typeof window.PWAUpdateTester !== 'undefined') loadedTools.push('PWAUpdateTester');

                console.log(`✅ Tools loaded: ${loadedTools.join(', ')}`);

                if (loadedTools.length === 0) {
                    console.warn('⚠️ No tools loaded - Check for script errors');
                }

                // Verificar estado del service worker después de que pwa-updater se haya inicializado
                if ('serviceWorker' in navigator && window.pwaUpdater) {
                    navigator.serviceWorker.ready.then(registration => {
                        if (registration.waiting) {
                            console.warn('⚠️ Service Worker is waiting - app might be showing old content');
                            console.log('💡 Run window.pwaUpdater.skipWaiting() to apply the update');
                        }
                    }).catch(error => {
                        console.error('❌ Error checking service worker ready state:', error);
                    });
                }

                // Mostrar comandos disponibles para testing
                if (isDevelopment && window.PWAUpdateTester) {
                    console.log('%c🧪 PWA TESTING COMMANDS AVAILABLE:', 'color: #00ff00; font-weight: bold;');
                    console.log('   testPWAUpdate() - Test update notification');
                    console.log('   getPWAState() - Get detailed SW state');
                    console.log('   checkPWACache() - Check cache info');
                    console.log('   testPWAConnectivity() - Test connectivity');
                    console.log('   resetPWA() - Reset PWA completely');
                }
            }, 1000);
        });

        // Global error handler for debugging
        window.addEventListener('error', function (event) {
            console.error('🚨 Global Error:', {
                message: event.message,
                source: event.filename,
                line: event.lineno,
                column: event.colno,
                error: event.error
            });
        });

        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function (event) {
            console.error('🚨 Unhandled Promise Rejection:', event.reason);
        });

        // Funciones globales para debugging - definidas aquí para estar disponibles inmediatamente
        window.forceSWUpdate = () => {
            if (window.pwaUpdater) {
                window.pwaUpdater.skipWaiting();
            } else {
                console.warn('PWA Updater not available yet, reloading page...');
                window.location.reload();
            }
        };

        window.manualUpdateCheck = () => {
            if (window.pwaUpdater) {
                return window.pwaUpdater.forceUpdateCheck();
            } else {
                console.warn('PWA Updater not available yet');
                return Promise.resolve(false);
            }
        };
    </script>
</body>

</html>
