<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registro de T√≠quets</title>
    <base href="/" />
    <link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/app.css" />
    <link rel="stylesheet" href="css/site.css" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <link href="Gastos.Pwa.styles.css" rel="stylesheet" />
    <link href="manifest.webmanifest" rel="manifest" />
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png" />
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
    <!-- Important: Increment the version parameter whenever you update MudBlazor to prevent caching issues -->
    <link href="_content/MudBlazor/MudBlazor.min.css?v=1" rel="stylesheet" />
    
    <!-- Cache prevention for main HTML -->
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="0">
</head>

<body>
    <div id="app">
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>
    </div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="." class="reload">Reload</a>
        <span class="dismiss">üóô</span>
    </div>

    <!-- PWA Routing Check - Load First -->
    <script src="js/pwa-routing-check.js"></script>

    <!-- PWA Scripts -->
    <script src="js/pwa-installer.js"></script>
    <script src="js/pwa-helper.js"></script>

    <!-- Authentication Script -->
    <script src="_content/Microsoft.AspNetCore.Components.WebAssembly.Authentication/AuthenticationService.js"></script>

    <!-- Auth Debug Script - Always load for troubleshooting -->
    <script src="js/auth-debug.js"></script>

    <!-- Azure Routing Test - Load after auth-debug -->
    <script src="js/azure-routing-test.js"></script>

    <!-- Utility Scripts -->
    <script src="js/clipboard-helper.js"></script>
    <script src="js/culture-helper.js"></script>

    <!-- Blazor WebAssembly -->
    <script src="_framework/blazor.webassembly.js"></script>

    <!-- MudBlazor JS -->
    <!-- Important: Increment the version parameter whenever you update MudBlazor to prevent caching issues -->
    <script src="_content/MudBlazor/MudBlazor.min.js?v=1"></script>

    <!-- Enhanced Service Worker Registration -->
    <script src="sw-registrator.js"></script>

    <!-- Error Handling for Authentication -->
    <script>
        // Detectar modo de desarrollo vs producci√≥n
        const isDevelopment = window.location.hostname === 'localhost' ||
            window.location.hostname === '127.0.0.1' ||
            window.location.hostname.includes('localhost');

        console.log(`üîß Environment: ${isDevelopment ? 'Development' : 'Production'}`);

        // Manejo global de errores relacionados con autenticaci√≥n
        window.addEventListener('error', function (event) {
            if (event.filename && event.filename.includes('authentication')) {
                console.error('üîê Authentication error:', {
                    message: event.message,
                    filename: event.filename,
                    line: event.lineno,
                    column: event.colno
                });
            }
        });

        // Manejo de promesas rechazadas relacionadas con autenticaci√≥n
        window.addEventListener('unhandledrejection', function (event) {
            if (event.reason && event.reason.toString().toLowerCase().includes('auth')) {
                console.error('üîê Authentication promise rejection:', event.reason);
            }
        });

        // Log del estado inicial de la aplicaci√≥n
        console.log('üöÄ Application loading...', {
            url: window.location.href,
            hostname: window.location.hostname,
            isPWA: window.matchMedia('(display-mode: standalone)').matches,
            hasServiceWorker: 'serviceWorker' in navigator,
            isDevelopment: isDevelopment,
            userAgent: navigator.userAgent,
            timestamp: new Date().toISOString()
        });

        // Verificar que todos los debuggers se hayan cargado
        setTimeout(() => {
            const debuggers = [];
            if (typeof window.AuthDebugger !== 'undefined') debuggers.push('AuthDebugger');
            if (typeof window.PWAInstaller !== 'undefined') debuggers.push('PWAInstaller');
            if (typeof window.PWARoutingDebug !== 'undefined') debuggers.push('PWARoutingDebug');
            if (typeof window.testAzureRouting !== 'undefined') debuggers.push('AzureRoutingTest');
            if (typeof window.pwaUpdater !== 'undefined') debuggers.push('PWAUpdater');

            console.log(`‚úÖ Debug tools loaded: ${debuggers.join(', ')}`);

            if (debuggers.length === 0) {
                console.warn('‚ö†Ô∏è No debug tools loaded - Troubleshooting may be limited');
            }

            // Exponer funciones de diagn√≥stico globales solo en desarrollo
            if (isDevelopment) {
                window.diagnoseApp = function() {
                    console.group('üîç Application Diagnostics');
                    console.log('Service Worker:', 'serviceWorker' in navigator ? 'Supported' : 'Not supported');
                    if ('serviceWorker' in navigator) {
                        navigator.serviceWorker.getRegistrations().then(registrations => {
                            console.log('SW Registrations:', registrations.length);
                            registrations.forEach((reg, index) => {
                                console.log(`SW ${index + 1}:`, {
                                    scope: reg.scope,
                                    active: !!reg.active,
                                    waiting: !!reg.waiting,
                                    installing: !!reg.installing
                                });
                            });
                        });
                    }
                    console.log('PWA Display Mode:', window.matchMedia('(display-mode: standalone)').matches ? 'Standalone' : 'Browser');
                    console.log('Cache API:', 'caches' in window ? 'Available' : 'Not available');
                    console.groupEnd();
                };
                
                console.log('üí° Tip: Run window.diagnoseApp() to get diagnostic information');
                console.log('üí° Tip: Run window.clearPWACache() to clear PWA cache manually');
                console.log('üí° Tip: Run window.checkPWAUpdates() to check for updates manually');
            }
        }, 3000);

        // Detectar cuando la aplicaci√≥n se est√° ejecutando desde cache obsoleto
        window.addEventListener('load', () => {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    if (registration.waiting) {
                        console.warn('‚ö†Ô∏è Service Worker is waiting - app might be showing old content');
                        
                        // En desarrollo, mostrar advertencia en consola
                        if (isDevelopment) {
                            console.log('üîß Development Mode: Consider refreshing to get latest version');
                        }
                    }
                });
            }
        });
    </script>
</body>

</html>
