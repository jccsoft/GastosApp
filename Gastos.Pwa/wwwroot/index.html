<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registro de Tíquets</title>
    <base href="/" />
    <link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/app.css" />
    <link rel="stylesheet" href="css/site.css" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <link href="Gastos.Pwa.styles.css" rel="stylesheet" />
    <link href="manifest.webmanifest" rel="manifest" />
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png" />
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
    <!-- Important: Increment the version parameter whenever you update MudBlazor to prevent caching issues -->
    <link href="_content/MudBlazor/MudBlazor.min.css?v=1" rel="stylesheet" />
</head>

<body>
    <div id="app">
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>
    </div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="." class="reload">Reload</a>
        <span class="dismiss">🗙</span>
    </div>

    <!-- PWA Routing Check - Load First -->
    <script src="js/pwa-routing-check.js"></script>

    <!-- PWA Scripts -->
    <script src="js/pwa-installer.js"></script>
    <script src="js/pwa-helper.js"></script>
    
    <!-- Authentication Script -->
    <script src="_content/Microsoft.AspNetCore.Components.WebAssembly.Authentication/AuthenticationService.js"></script>
    
    <!-- Debug Script - Only in Development -->
    <script>
        // Cargar script de debug solo en desarrollo
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            const script = document.createElement('script');
            script.src = 'js/auth-debug.js';
            script.onload = () => console.log('🔧 Auth debug script loaded');
            document.head.appendChild(script);
            console.log('🔧 Development mode detected - Loading auth debug script');
        }
    </script>
    
    <!-- Utility Scripts -->
    <script src="js/clipboard.js"></script>
    <script src="js/setCulture.js"></script>

    <!-- Blazor WebAssembly -->
    <script src="_framework/blazor.webassembly.js"></script>

    <!-- MudBlazor JS -->
    <!-- Important: Increment the version parameter whenever you update MudBlazor to prevent caching issues -->
    <script src="_content/MudBlazor/MudBlazor.min.js?v=1"></script>

    <!-- PWA Service Worker with Enhanced Error Handling -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js', { 
                updateViaCache: 'none' 
            })
            .then(registration => {
                console.log('✅ ServiceWorker registration successful:', registration);
                
                // Escuchar actualizaciones del service worker
                registration.addEventListener('updatefound', () => {
                    console.log('🔄 ServiceWorker update found');
                    const newWorker = registration.installing;
                    
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'activated') {
                            console.log('🔄 New ServiceWorker activated');
                            // Opcional: mostrar notificación de actualización
                        }
                    });
                });
            })
            .catch(error => {
                console.error('❌ ServiceWorker registration failed:', error);
            });

            // Escuchar cambios en el service worker
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                console.log('🔄 ServiceWorker controller changed');
                // Opcional: recargar la página cuando hay un nuevo service worker
                // window.location.reload();
            });

            // Verificar si hay un service worker esperando
            navigator.serviceWorker.ready.then(registration => {
                if (registration.waiting) {
                    console.log('⏳ ServiceWorker waiting to activate');
                }
            });
        } else {
            console.log('❌ ServiceWorker not supported');
        }
    </script>

    <!-- Error Handling for Authentication -->
    <script>
        // Manejo global de errores relacionados con autenticación
        window.addEventListener('error', function(event) {
            if (event.filename && event.filename.includes('authentication')) {
                console.error('🔐 Authentication error:', {
                    message: event.message,
                    filename: event.filename,
                    line: event.lineno,
                    column: event.colno
                });
            }
        });

        // Manejo de promesas rechazadas relacionadas con autenticación
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.toString().toLowerCase().includes('auth')) {
                console.error('🔐 Authentication promise rejection:', event.reason);
            }
        });

        // Log del estado inicial de la aplicación
        console.log('🚀 Application loading...', {
            url: window.location.href,
            isPWA: window.matchMedia('(display-mode: standalone)').matches,
            hasServiceWorker: 'serviceWorker' in navigator,
            userAgent: navigator.userAgent
        });
    </script>
</body>

</html>
